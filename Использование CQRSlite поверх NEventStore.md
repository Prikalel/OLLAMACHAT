—Å–º. https://github.com/Prikalel/OLLAMACHAT/issues/10

### üß© –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CQRSlite –ø–æ–≤–µ—Ä—Ö NEventStore: –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è  

–°–æ—á–µ—Ç–∞–Ω–∏–µ **CQRSlite** (–ª–µ–≥–∫–æ–≤–µ—Å–Ω–æ–≥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ –¥–ª—è CQRS/Event Sourcing) –∏ **NEventStore** (–ø–æ–ø—É–ª—è—Ä–Ω–æ–π .NET-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π) –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–µ –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã. –†–∞—Å—Å–º–æ—Ç—Ä–∏–º –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.

---

#### üß† 1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–æ–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤**
- **CQRSlite**:
  - –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–∞–∑–æ–≤—ã–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–ª—è CQRS/Event Sourcing: `AggregateRoot`, `Command`, `Event`, `Repository` .
  - –£–ø—Ä–æ—â–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–º–∞–Ω–¥, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∫ –∞–≥—Ä–µ–≥–∞—Ç–∞–º –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ü–∏—è–º–∏.
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç in-memory –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è. –ù–æ –≤ –Ω–∞—à–µ–π –∑–∞–¥–∞—á–µ —ç—Ç–æ –Ω–∞–º –Ω–µ –Ω–∞–¥–æ.
- **NEventStore**:
  - –†–µ–∞–ª–∏–∑—É–µ—Ç –∂—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π (Event Store) —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –±—ç–∫–µ–Ω–¥–æ–≤ (SQL, NoSQL, Redis).
  - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏ —Å–æ–±—ã—Ç–∏–π –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (append-only) .
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–æ–Ω–≤–µ–π–µ—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π (pipelines) –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–ª–∏ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

---

#### ‚öôÔ∏è 2. **–°—Ö–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏**
```mermaid
graph LR
A[–ö–æ–º–∞–Ω–¥–∞] --> B[CQRSlite CommandHandler]
B --> C[CQRSlite Aggregate]
C --> D[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π]
D --> E[NEventStore: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π]
E --> F[–ü—Ä–æ–µ–∫—Ü–∏–∏ CQRSlite]
E --> G[–í–Ω–µ—à–Ω–∏–µ —Ä–µ–∞–∫—Ç–æ—Ä—ã]
```

- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥**:
  - `CommandHandler` –≤ CQRSlite –≤—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥ –∞–≥—Ä–µ–≥–∞—Ç–∞.
  - –ê–≥—Ä–µ–≥–∞—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `BookBorrowedEvent` ).
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π**:
  - –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π CQRSlite –ø–µ—Ä–µ–¥–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ NEventStore —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `Commit`.
  - –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞:
    ```csharp
    public async Task SaveAsync(AggregateRoot aggregate)
    {
        var events = aggregate.GetUncommittedChanges();
        using (var stream = _eventStore.OpenStream(aggregate.Id))
        {
            foreach (var e in events)
                stream.Add(new EventMessage { Body = e });
            stream.CommitChanges(Guid.NewGuid());
        }
    }
    ```
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≥—Ä–µ–≥–∞—Ç–∞**:
  - CQRSlite –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ NEventStore –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∏—Ö –∫ –∞–≥—Ä–µ–≥–∞—Ç—É —á–µ—Ä–µ–∑ `LoadFromHistory` .

---

#### üöÄ 3. **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏**
- **–ì–∏–±–∫–æ—Å—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞**:
  - NEventStore –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SQL Server, PostgreSQL, MongoDB, –∏ –ø—Ä–æ—á. –ù–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç —Ç–æ–ª—å–∫–æ sqlite.
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
  - NEventStore –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–ø–∏—Å–∏ –ø–æ—Ç–æ–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π (–¥–æ 50K —Å–æ–±—ã—Ç–∏–π/—Å–µ–∫) .
- **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**:
  - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ—Ç–æ–∫–∞ —Å–æ–±—ã—Ç–∏–π (stream) –≤ NEventStore.
- **–ê—É–¥–∏—Ç –∏ –æ—Ç–ª–∞–¥–∫–∞**:
  - –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π –≤ NEventStore –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ .

---

#### ‚ö†Ô∏è 4. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ä–µ—à–µ–Ω–∏—è**
| **–ü—Ä–æ–±–ª–µ–º–∞**                     | **–†–µ—à–µ–Ω–∏–µ**                                                                 |
|----------------------------------|-----------------------------------------------------------------------------|
| **–ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ö–µ–º —Å–æ–±—ã—Ç–∏–π**        | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `Upconverters` –≤ NEventStore –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π. |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ü–∏–π**  | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ —Ä–µ–∞–∫—Ç–æ—Ä—ã CQRSlite .          |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏**            | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö —Å –ø–æ–º–æ—â—å—é NLog.                |
| **–†–æ—Å—Ç —Ä–∞–∑–º–µ—Ä–∞ Event Store**     | –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ + —Å–Ω—ç–ø—à–æ—Ç—ã –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –≤ CQRSlite .      |

> —Å–æ —Å–Ω–∞–ø—à–æ—Ç–∞–º–∏ –∞–≥–≥–Ω–µ–≥–∞—Ç–æ–≤ –Ω—É–∂–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è –ø–æ–¥—Ä–æ–±–Ω–µ–µ –∏ —É–∑–Ω–∞—Ç—å —á—Ç–æ —ç—Ç–æ –∏ —Å —á–µ–º –µ–¥—è—Ç.

---

#### üíé –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è CQRSlite –∏ NEventStore –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–∏—Å—Ç–µ–º —Å –≤—ã—Å–æ–∫–∏–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –∫ –∞—É–¥–∏—Ç—É –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏ (—Ñ–∏–Ω–∞–Ω—Å—ã, –ª–æ–≥–∏—Å—Ç–∏–∫–∞).

–ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:  
- [CQRSlite + EventStore](https://github.com/gautema/CQRSlite) (—à–∞–±–ª–æ–Ω –¥–ª—è —Å—Ç–∞—Ä—Ç–∞).  
- [NEventStore + SQL](https://github.com/NEventStore/NEventStore) (–¥–µ–º–æ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π).
